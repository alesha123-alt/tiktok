<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLANNER KONTEN 30 HARI</title>
    <!-- FIREBASE SDK - Kabel untuk terhubung ke database online -->
<script type="module">
    // Import fungsi yang kita butuhkan dari Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- FUNGSI UTAMA (MAIN) ---
async function main() {
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                setupRealtimeListeners(); // Panggil listener setelah login
            } else {
                // Logika untuk login secara anonim
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            }
        });
    } catch (error) { /* ... penanganan error ... */ }
}

// --- KONEKSI REAL-TIME KE DATABASE ---
function setupRealtimeListeners() {
    if (!userId) return;

    // Listener untuk koleksi 'accounts'
    const accountsRef = collection(db, "artifacts", appId, "users", userId, "accounts");
    onSnapshot(accountsRef, (snapshot) => {
        accounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderAll();
    });

    // Listener untuk koleksi 'contents'
    const contentsRef = collection(db, "artifacts", appId, "users", userId, "contents");
    onSnapshot(contentsRef, (snapshot) => {
        contents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderAll();
    });
}
contentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!userId) return alert("Belum terhubung ke server, silakan tunggu.");
    // ...
    try {
        // Mengirim data langsung ke database online
        await addDoc(collection(db, "artifacts", appId, "users", userId, "contents"), {
            // ... data konten ...
        });
        contentForm.reset();
        // Tidak perlu saveData() atau renderAll() lagi,
        // karena listener di #3 akan otomatis melakukannya.
    } catch (error) { /* ... penanganan error ... */ }
});
</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f9ff; /* Latar belakang biru muda yang lembut */
        }
        .table-container {
            overflow-x: auto;
        }
        .btn-action:hover {
            transform: translateY(-2px);
            transition: all 0.2s;
        }
        .calendar-day {
            min-height: 100px;
            transition: all 0.2s;
        }
        .calendar-day:hover {
            background-color: #e0f2fe; /* Warna hover sedikit lebih gelap */
        }
        .content-item {
            border-left: 4px solid;
            transition: all 0.2s;
            cursor: pointer;
        }
        .content-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .account-badge {
            transition: all 0.2s;
        }
        .account-badge:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6">
        <h1 class="text-2xl md:text-3xl font-bold text-center mb-6 text-indigo-700">PLANNER KONTEN 30 HARI</h1>

        <!-- Daftar Akun -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-indigo-700">Daftar Akun</h2>
                <button id="addAccountBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg flex items-center btn-action">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Tambah Akun
                </button>
            </div>
            <div id="accountsList" class="flex flex-wrap gap-2 mb-4">
                <!-- Akun akan diisi oleh JavaScript -->
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <div class="w-full md:w-1/3">
                <div class="bg-indigo-50 p-4 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4 text-indigo-700">Tambah Konten</h2>
                    <form id="contentForm">
                        <div class="mb-4">
                            <label for="contentTitle" class="block text-gray-700 mb-1">Judul Konten</label>
                            <input type="text" id="contentTitle" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="mb-4">
                            <label for="contentAccount" class="block text-gray-700 mb-1">Akun</label>
                            <select id="contentAccount" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                <!-- Opsi akun akan diisi oleh JavaScript -->
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="contentDate" class="block text-gray-700 mb-1">Tanggal Publikasi</label>
                            <input type="date" id="contentDate" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="mb-4">
                            <label for="contentStatus" class="block text-gray-700 mb-1">Status</label>
                            <select id="contentStatus" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="idea">Ide</option>
                                <option value="draft">Draft</option>
                                <option value="review">Review</option>
                                <option value="scheduled">Terjadwal</option>
                                <option value="published">Dipublikasi</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="contentProduct" class="block text-gray-700 mb-1">Produk Affiliate</label>
                            <input type="text" id="contentProduct" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="mb-4">
                            <label for="contentDesc" class="block text-gray-700 mb-1">Deskripsi</label>
                            <textarea id="contentDesc" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="3"></textarea>
                        </div>
                        <button type="submit" class="w-full px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition btn-action">Simpan Konten</button>
                    </form>
                </div>
            </div>

            <div class="w-full md:w-2/3">
                <div class="bg-white p-4 rounded-lg shadow border">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-indigo-700">Kalender Konten</h2>
                        <div class="flex gap-2">
                            <button id="prevMonth" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg btn-action">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <span id="currentMonth" class="font-medium text-lg flex items-center"></span>
                            <button id="nextMonth" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg btn-action">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-7 gap-1 mb-2 text-center font-medium text-gray-500">
                        <div>Min</div>
                        <div>Sen</div>
                        <div>Sel</div>
                        <div>Rab</div>
                        <div>Kam</div>
                        <div>Jum</div>
                        <div>Sab</div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1">
                        <!-- Calendar will be generated here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8">
            <h2 class="text-xl font-bold mb-4 text-indigo-700">Daftar Konten Affiliate</h2>
            
            <div class="flex flex-wrap items-center gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
                <span class="font-medium text-gray-700">Ekspor Laporan PDF:</span>
                <div class="flex items-center gap-2">
                    <label for="startDate" class="text-sm">Dari:</label>
                    <input type="date" id="startDate" class="px-2 py-1 border rounded-lg text-sm">
                </div>
                <div class="flex items-center gap-2">
                    <label for="endDate" class="text-sm">Sampai:</label>
                    <input type="date" id="endDate" class="px-2 py-1 border rounded-lg text-sm">
                </div>
                <button id="exportPdfBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center text-sm btn-action">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm1 4a1 1 0 100 2h8a1 1 0 100-2H5zm0 4a1 1 0 100 2h8a1 1 0 100-2H5zm0 4a1 1 0 100 2h4a1 1 0 100-2H5z" clip-rule="evenodd" />
                    </svg>
                    Ekspor PDF
                </button>
            </div>
            
            <div class="mb-4 flex flex-col md:flex-row justify-between gap-2">
                <div class="flex flex-col md:flex-row gap-2">
                    <input type="text" id="searchInput" placeholder="Cari konten..." class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <select id="filterAccount" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Semua Akun</option>
                    </select>
                    <select id="filterStatus" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Semua Status</option>
                        <option value="idea">Ide</option>
                        <option value="draft">Draft</option>
                        <option value="review">Review</option>
                        <option value="scheduled">Terjadwal</option>
                        <option value="published">Dipublikasi</option>
                    </select>
                </div>
            </div>

            <div class="table-container">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <thead class="bg-indigo-600 text-white">
                        <tr>
                            <th class="py-3 px-4 text-left">Judul</th>
                            <th class="py-3 px-4 text-left">Akun</th>
                            <th class="py-3 px-4 text-left">Produk</th>
                            <th class="py-3 px-4 text-left">Tanggal</th>
                            <th class="py-3 px-4 text-left">Status</th>
                            <th class="py-3 px-4 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="contentTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Modals -->
        <div id="accountModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h2 id="accountModalTitle" class="text-xl font-bold mb-4">Tambah Akun Baru</h2>
                <form id="accountForm">
                    <input type="hidden" id="editAccountId">
                    <div class="mb-4">
                        <label for="accountName" class="block text-gray-700 mb-1">Nama Akun</label>
                        <input type="text" id="accountName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="accountPlatform" class="block text-gray-700 mb-1">Platform</label>
                        <select id="accountPlatform" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="instagram">Instagram</option>
                            <option value="tiktok">TikTok</option>
                            <option value="facebook">Facebook</option>
                            <option value="twitter">Twitter</option>
                            <option value="youtube">YouTube</option>
                            <option value="blog">Blog</option>
                            <option value="other">Lainnya</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="accountColor" class="block text-gray-700 mb-1">Warna Label</label>
                        <input type="color" id="accountColor" class="w-full h-10 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" value="#4f46e5">
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" id="cancelAccountButton" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg">Batal</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">Simpan</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h2 class="text-xl font-bold mb-4">Edit Konten</h2>
                <form id="editForm">
                    <input type="hidden" id="editId">
                    <div class="mb-4"><label for="editTitle" class="block">Judul</label><input type="text" id="editTitle" class="w-full p-2 border rounded" required></div>
                    <div class="mb-4"><label for="editAccount" class="block">Akun</label><select id="editAccount" class="w-full p-2 border rounded"></select></div>
                    <div class="mb-4"><label for="editDate" class="block">Tanggal</label><input type="date" id="editDate" class="w-full p-2 border rounded" required></div>
                    <div class="mb-4"><label for="editStatus" class="block">Status</label><select id="editStatus" class="w-full p-2 border rounded"><option value="idea">Ide</option><option value="draft">Draft</option><option value="review">Review</option><option value="scheduled">Terjadwal</option><option value="published">Dipublikasi</option></select></div>
                    <div class="mb-4"><label for="editProduct" class="block">Produk</label><input type="text" id="editProduct" class="w-full p-2 border rounded"></div>
                    <div class="mb-4"><label for="editDesc" class="block">Deskripsi</label><textarea id="editDesc" class="w-full p-2 border rounded" rows="3"></textarea></div>
                    <div class="flex justify-end gap-2"><button type="button" id="cancelEditButton" class="px-4 py-2 bg-gray-300 rounded">Batal</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Simpan</button></div>
                </form>
            </div>
        </div>

        <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h2 class="text-xl font-bold mb-4">Konfirmasi Hapus</h2>
                <p>Apakah Anda yakin ingin menghapus item ini?</p>
                <input type="hidden" id="deleteId"><input type="hidden" id="deleteType">
                <div class="flex justify-end gap-2 mt-4"><button type="button" id="cancelDeleteButton" class="px-4 py-2 bg-gray-300 rounded">Batal</button><button type="button" id="confirmDeleteButton" class="px-4 py-2 bg-red-600 text-white rounded">Hapus</button></div>
            </div>
        </div>

        <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h2 id="detailTitle" class="text-xl font-bold mb-2"></h2>
                <div class="flex gap-2 mb-4"><span id="detailAccount" class="px-2 py-1 rounded-full text-xs"></span><span id="detailStatus" class="px-2 py-1 rounded-full text-xs"></span></div>
                <p class="text-sm text-gray-500 mb-2">Tanggal Publikasi: <span id="detailDate"></span></p>
                <p class="text-sm text-gray-500 mb-2">Produk Affiliate: <span id="detailProduct"></span></p>
                <div class="border-t pt-3 mt-3"><h3 class="font-medium mb-2">Deskripsi:</h3><p id="detailDesc" class="text-gray-700"></p></div>
                <div class="flex justify-end mt-4"><button type="button" id="closeDetailButton" class="px-4 py-2 bg-gray-300 rounded">Tutup</button></div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Kunci untuk localStorage
    const ACCOUNTS_STORAGE_KEY = 'planner_accounts';
    const CONTENTS_STORAGE_KEY = 'planner_contents';

    // Elemen DOM
    const accountsList = document.getElementById('accountsList');
    const contentTableBody = document.getElementById('contentTableBody');
    const searchInput = document.getElementById('searchInput');
    const filterStatus = document.getElementById('filterStatus');
    const filterAccount = document.getElementById('filterAccount');
    const contentForm = document.getElementById('contentForm');
    const contentAccount = document.getElementById('contentAccount');
    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    const editAccount = document.getElementById('editAccount');
    const cancelEditButton = document.getElementById('cancelEditButton');
    const deleteModal = document.getElementById('deleteModal');
    const cancelDeleteButton = document.getElementById('cancelDeleteButton');
    const confirmDeleteButton = document.getElementById('confirmDeleteButton');
    const detailModal = document.getElementById('detailModal');
    const closeDetailButton = document.getElementById('closeDetailButton');
    const calendarGrid = document.getElementById('calendarGrid');
    const currentMonthElement = document.getElementById('currentMonth');
    const prevMonthButton = document.getElementById('prevMonth');
    const nextMonthButton = document.getElementById('nextMonth');
    const addAccountBtn = document.getElementById('addAccountBtn');
    const accountModal = document.getElementById('accountModal');
    const accountForm = document.getElementById('accountForm');
    const cancelAccountButton = document.getElementById('cancelAccountButton');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');

    // Variabel Data Aplikasi
    let accounts = [];
    let contents = [];
    
    // Variabel Kalender
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();

    // --- FUNGSI PENYIMPANAN & PEMUATAN DATA ---

    function saveData() {
        localStorage.setItem(ACCOUNTS_STORAGE_KEY, JSON.stringify(accounts));
        localStorage.setItem(CONTENTS_STORAGE_KEY, JSON.stringify(contents));
    }

    function loadData() {
        const savedAccounts = localStorage.getItem(ACCOUNTS_STORAGE_KEY);
        const savedContents = localStorage.getItem(CONTENTS_STORAGE_KEY);

        if (savedAccounts) {
            accounts = JSON.parse(savedAccounts);
        } else {
            // Data awal jika localStorage kosong
            accounts = [
                { id: 1, name: "@affiliate_master", platform: "instagram", color: "#E1306C" },
                { id: 2, name: "Blog Juara", platform: "blog", color: "#2ECC71" },
                { id: 3, name: "@tiktok_racun", platform: "tiktok", color: "#00F2EA" }
            ];
        }

        if (savedContents) {
            contents = JSON.parse(savedContents);
        } else {
            // Data awal jika localStorage kosong
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            contents = [
                { id: 1, title: "Review Skincare Viral", accountId: 1, date: `${year}-${month}-15`, status: "published", product: "Skincare XYZ", description: "Review lengkap tentang produk skincare XYZ dengan link affiliate." },
                { id: 2, title: "10 Gadget Wajib Punya", accountId: 3, date: `${year}-${month}-20`, status: "scheduled", product: "Gadget ABC", description: "Video unboxing 10 gadget terbaik dengan link di bio." },
            ];
        }
    }

    // --- FUNGSI RENDER TAMPILAN ---

    function renderAll() {
        renderAccounts();
        filterContents(); // Ini akan memanggil renderContentTable
        renderCalendar(currentMonth, currentYear);
    }

    function renderAccounts() {
        accountsList.innerHTML = '';
        if (accounts.length === 0) return;
        
        accounts.forEach(account => {
            const accountBadge = document.createElement('div');
            accountBadge.className = 'account-badge flex items-center bg-white border rounded-full px-3 py-1 shadow-sm';
            accountBadge.style.borderColor = account.color;
            accountBadge.innerHTML = `
                <span class="mr-2">${getPlatformIcon(account.platform)}</span>
                <span class="font-medium">${account.name}</span>
                <div class="ml-2 flex">
                    <button class="edit-account-btn text-blue-500 hover:text-blue-700 mr-1" data-id="${account.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button>
                    <button class="delete-account-btn text-red-500 hover:text-red-700" data-id="${account.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                </div>
            `;
            accountsList.appendChild(accountBadge);
        });
        document.querySelectorAll('.edit-account-btn').forEach(btn => btn.addEventListener('click', handleEditAccount));
        document.querySelectorAll('.delete-account-btn').forEach(btn => btn.addEventListener('click', handleDeleteClick));
        updateAccountDropdowns();
    }

    function renderContentTable(contentsToRender) {
        contentTableBody.innerHTML = '';
        if (contentsToRender.length === 0) {
            contentTableBody.innerHTML = `<tr><td colspan="6" class="py-4 px-4 text-center text-gray-500">Tidak ada konten yang ditemukan</td></tr>`;
            return;
        }
        contentsToRender.forEach((item, index) => {
            const row = document.createElement('tr');
            row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
            const account = accounts.find(acc => acc.id === parseInt(item.accountId)) || { name: 'N/A', color: '#999999' };
            row.innerHTML = `
                <td class="py-3 px-4 border-b">${item.title}</td>
                <td class="py-3 px-4 border-b"><span class="px-2 py-1 rounded-full text-xs" style="background-color: ${account.color}20; color: ${account.color}">${account.name}</span></td>
                <td class="py-3 px-4 border-b">${item.product || '-'}</td>
                <td class="py-3 px-4 border-b">${formatDate(item.date)}</td>
                <td class="py-3 px-4 border-b"><span class="px-2 py-1 rounded-full text-xs ${getStatusClass(item.status)}">${getStatusLabel(item.status)}</span></td>
                <td class="py-3 px-4 border-b text-center">
                    <button class="btn-action view-btn bg-indigo-500 hover:bg-indigo-600 text-white p-1 rounded mr-1" data-id="${item.id}"><svg class="h-5 w-5 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg></button>
                    <button class="btn-action edit-btn bg-blue-500 hover:bg-blue-600 text-white p-1 rounded mr-1" data-id="${item.id}"><svg class="h-5 w-5 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button>
                    <button class="btn-action delete-btn bg-red-500 hover:bg-red-600 text-white p-1 rounded" data-id="${item.id}"><svg class="h-5 w-5 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                </td>
            `;
            contentTableBody.appendChild(row);
        });
        document.querySelectorAll('.view-btn').forEach(btn => btn.addEventListener('click', handleViewClick));
        document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEditClick));
        document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDeleteClick));
    }

    function renderCalendar(month, year) {
        calendarGrid.innerHTML = '';
        const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        currentMonthElement.textContent = `${monthNames[month]} ${year}`;
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDayOfMonth; i++) {
            calendarGrid.appendChild(document.createElement('div')).className = 'border bg-gray-50 p-1';
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'border p-1 calendar-day overflow-y-auto';
            const today = new Date();
            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayElement.classList.add('bg-indigo-50', 'border-indigo-300');
            }
            dayElement.innerHTML = `<div class="text-sm font-medium mb-1">${day}</div>`;
            const contentContainer = document.createElement('div');
            contentContainer.className = 'space-y-1';
            const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayContents = contents.filter(item => item.date === currentDateStr);
            
            dayContents.forEach(content => {
                const account = accounts.find(acc => acc.id === parseInt(content.accountId)) || { color: '#999999' };
                const contentItem = document.createElement('div');
                contentItem.className = 'content-item text-xs p-1 bg-white rounded';
                contentItem.style.borderLeftColor = account.color;
                contentItem.textContent = content.title;
                contentItem.dataset.id = content.id;
                contentItem.addEventListener('click', (e) => handleViewClick({ currentTarget: e.target }));
                contentContainer.appendChild(contentItem);
            });
            dayElement.appendChild(contentContainer);
            calendarGrid.appendChild(dayElement);
        }
    }

    // --- FUNGSI HELPERS ---
    
    function updateAccountDropdowns() {
        const dropdowns = [contentAccount, editAccount, filterAccount];
        dropdowns.forEach((dropdown, index) => {
            const currentValue = dropdown.value;
            dropdown.innerHTML = '';
            if(index === 2) dropdown.innerHTML = '<option value="">Semua Akun</option>'; // Hanya untuk filter
            accounts.forEach(account => {
                dropdown.innerHTML += `<option value="${account.id}">${account.name}</option>`;
            });
            dropdown.value = currentValue;
        });
    }

    function getPlatformIcon(platform) {
        const icons = {
            instagram: '<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>',
            tiktok: '<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/></svg>',
            facebook: '<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385h-3.047v-3.47h3.047v-2.642c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953h-1.514c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385c5.736-.9 10.125-5.864 10.125-11.854z"/></svg>',
            twitter: '<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>',
            youtube: '<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>',
            blog: '<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"/></svg>',
            'other': '<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>'
        };
        return icons[platform] || icons['default'];
    }

    function formatDate(dateString) {
        if(!dateString) return "N/A";
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        return new Date(dateString).toLocaleDateString('id-ID', options);
    }

    function getStatusLabel(status) {
        const statuses = { 'idea': 'Ide', 'draft': 'Draft', 'review': 'Review', 'scheduled': 'Terjadwal', 'published': 'Dipublikasi' };
        return statuses[status] || status;
    }

    function getStatusClass(status) {
        const classes = {
            'published': 'bg-green-100 text-green-800',
            'scheduled': 'bg-blue-100 text-blue-800',
            'review': 'bg-yellow-100 text-yellow-800',
            'draft': 'bg-gray-100 text-gray-800',
            'idea': 'bg-purple-100 text-purple-800'
        };
        return classes[status] || 'bg-gray-100 text-gray-800';
    }

    function filterContents() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusFilter = filterStatus.value;
        const accountFilter = filterAccount.value;
        const filteredContents = contents.filter(item => {
            const matchSearch = item.title.toLowerCase().includes(searchTerm) ||
                (item.description && item.description.toLowerCase().includes(searchTerm)) ||
                (item.product && item.product.toLowerCase().includes(searchTerm));
            const matchStatus = !statusFilter || item.status === statusFilter;
            const matchAccount = !accountFilter || parseInt(item.accountId) === parseInt(accountFilter);
            return matchSearch && matchStatus && matchAccount;
        });
        renderContentTable(filteredContents);
    }

    // --- FUNGSI EVENT HANDLERS ---
    
    // CRUD Konten
    contentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const newId = contents.length > 0 ? Math.max(...contents.map(item => item.id)) + 1 : 1;
        contents.push({
            id: newId,
            title: document.getElementById('contentTitle').value,
            accountId: parseInt(document.getElementById('contentAccount').value),
            date: document.getElementById('contentDate').value,
            status: document.getElementById('contentStatus').value,
            product: document.getElementById('contentProduct').value,
            description: document.getElementById('contentDesc').value
        });
        contentForm.reset();
        saveData();
        renderAll();
    });

    editForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = parseInt(document.getElementById('editId').value);
        const index = contents.findIndex(item => item.id === id);
        if (index !== -1) {
            contents[index] = {
                ...contents[index],
                title: document.getElementById('editTitle').value,
                accountId: parseInt(document.getElementById('editAccount').value),
                date: document.getElementById('editDate').value,
                status: document.getElementById('editStatus').value,
                product: document.getElementById('editProduct').value,
                description: document.getElementById('editDesc').value
            };
        }
        editModal.classList.add('hidden');
        saveData();
        renderAll();
    });

    // CRUD Akun
    addAccountBtn.addEventListener('click', () => {
        document.getElementById('accountModalTitle').textContent = 'Tambah Akun Baru';
        accountForm.reset();
        document.getElementById('editAccountId').value = '';
        document.getElementById('accountColor').value = '#4f46e5';
        accountModal.classList.remove('hidden');
    });

    accountForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const editId = document.getElementById('editAccountId').value;
        const accountData = {
            name: document.getElementById('accountName').value,
            platform: document.getElementById('accountPlatform').value,
            color: document.getElementById('accountColor').value
        };
        if (editId) {
            const index = accounts.findIndex(acc => acc.id === parseInt(editId));
            if (index !== -1) accounts[index] = { ...accounts[index], ...accountData };
        } else {
            const newId = accounts.length > 0 ? Math.max(...accounts.map(acc => acc.id)) + 1 : 1;
            accounts.push({ id: newId, ...accountData });
        }
        accountModal.classList.add('hidden');
        saveData();
        renderAll();
    });

    confirmDeleteButton.addEventListener('click', () => {
        const id = parseInt(document.getElementById('deleteId').value);
        const type = document.getElementById('deleteType').value;
        if (type === 'content') {
            contents = contents.filter(item => item.id !== id);
        } else if (type === 'account') {
            if (contents.some(item => parseInt(item.accountId) === id)) {
                alert('Akun ini masih digunakan oleh konten. Harap hapus atau pindahkan konten terlebih dahulu.');
            } else {
                accounts = accounts.filter(acc => acc.id !== id);
            }
        }
        deleteModal.classList.add('hidden');
        saveData();
        renderAll();
    });

    // Event Handlers untuk klik tombol
    function handleViewClick({ currentTarget }) {
        const id = parseInt(currentTarget.dataset.id);
        const item = contents.find(x => x.id === id);
        if (item) {
            document.getElementById('detailTitle').textContent = item.title;
            const account = accounts.find(acc => acc.id === parseInt(item.accountId)) || { name: 'N/A', color: '#999999' };
            const accountElement = document.getElementById('detailAccount');
            accountElement.textContent = account.name;
            accountElement.style.backgroundColor = `${account.color}20`;
            accountElement.style.color = account.color;
            const statusElement = document.getElementById('detailStatus');
            statusElement.textContent = getStatusLabel(item.status);
            statusElement.className = `px-2 py-1 rounded-full text-xs ${getStatusClass(item.status)}`;
            document.getElementById('detailDate').textContent = formatDate(item.date);
            document.getElementById('detailProduct').textContent = item.product || '-';
            document.getElementById('detailDesc').textContent = item.description || 'Tidak ada deskripsi.';
            detailModal.classList.remove('hidden');
        }
    }

    function handleEditClick({ currentTarget }) {
        const id = parseInt(currentTarget.dataset.id);
        const item = contents.find(x => x.id === id);
        if (item) {
            document.getElementById('editId').value = item.id;
            document.getElementById('editTitle').value = item.title;
            document.getElementById('editAccount').value = item.accountId;
            document.getElementById('editDate').value = item.date;
            document.getElementById('editStatus').value = item.status;
            document.getElementById('editProduct').value = item.product || '';
            document.getElementById('editDesc').value = item.description || '';
            editModal.classList.remove('hidden');
        }
    }

    function handleEditAccount({ currentTarget }) {
        const id = parseInt(currentTarget.dataset.id);
        const account = accounts.find(acc => acc.id === id);
        if (account) {
            document.getElementById('accountModalTitle').textContent = 'Edit Akun';
            document.getElementById('editAccountId').value = account.id;
            document.getElementById('accountName').value = account.name;
            document.getElementById('accountPlatform').value = account.platform;
            document.getElementById('accountColor').value = account.color;
            accountModal.classList.remove('hidden');
        }
    }
    
    function handleDeleteClick({ currentTarget }) {
        const id = parseInt(currentTarget.dataset.id);
        const type = currentTarget.classList.contains('delete-account-btn') ? 'account' : 'content';
        document.getElementById('deleteId').value = id;
        document.getElementById('deleteType').value = type;
        deleteModal.classList.remove('hidden');
    }
    
    // Event listener untuk filter
    searchInput.addEventListener('input', filterContents);
    filterStatus.addEventListener('change', filterContents);
    filterAccount.addEventListener('change', filterContents);

    // Event listener untuk tutup modal
    cancelEditButton.addEventListener('click', () => editModal.classList.add('hidden'));
    cancelDeleteButton.addEventListener('click', () => deleteModal.classList.add('hidden'));
    closeDetailButton.addEventListener('click', () => detailModal.classList.add('hidden'));
    cancelAccountButton.addEventListener('click', () => accountModal.classList.add('hidden'));

    // Event listener untuk navigasi kalender
    prevMonthButton.addEventListener('click', () => {
        currentMonth--;
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        renderCalendar(currentMonth, currentYear);
    });
    nextMonthButton.addEventListener('click', () => {
        currentMonth++;
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        renderCalendar(currentMonth, currentYear);
    });
    
    // --- FUNGSI EKSPOR PDF ---
    
    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        
        if (!startDate || !endDate) {
            alert('Silakan pilih rentang tanggal terlebih dahulu.');
            return;
        }
        
        const filteredData = contents.filter(item => item.date >= startDate && item.date <= endDate);
        
        if (filteredData.length === 0) {
            alert('Tidak ada data konten pada rentang tanggal yang dipilih.');
            return;
        }
        
        filteredData.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        doc.setFontSize(18);
        doc.text('Laporan Konten Affiliate', 14, 22);
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text(`Periode: ${formatDate(startDate)} - ${formatDate(endDate)}`, 14, 30);
        
        let yPos = 45;
        
        filteredData.forEach((item, index) => {
            if (yPos > 260) {
                doc.addPage();
                yPos = 20;
            }
            
            const account = accounts.find(acc => acc.id === parseInt(item.accountId)) || { name: 'N/A' };
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(`${index + 1}. ${item.title}`, 14, yPos);
            yPos += 7;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`   - Tanggal: ${formatDate(item.date)} | Akun: ${account.name} | Status: ${getStatusLabel(item.status)}`, 14, yPos);
            yPos += 5;
            doc.text(`   - Produk: ${item.product || '-'}`, 14, yPos);
            yPos += 5;

            doc.setFont(undefined, 'italic');
            doc.setTextColor(150);
            const descriptionLines = doc.splitTextToSize(`     "${item.description || 'Tidak ada deskripsi.'}"`, 170);
            doc.text(descriptionLines, 14, yPos);
            yPos += (descriptionLines.length * 4) + 5;
            
            doc.setTextColor(0);
        });
        
        const pageCount = doc.internal.getNumberOfPages();
        for(let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text(`Halaman ${i} dari ${pageCount}`, doc.internal.pageSize.getWidth() - 30, doc.internal.pageSize.getHeight() - 10);
        }
        
        doc.save(`Laporan_Konten_${startDate}_sd_${endDate}.pdf`);
    }
    exportPdfBtn.addEventListener('click', exportToPDF);

    // Inisialisasi Aplikasi
    loadData();
    renderAll();
});
</script>

</body>
</html>
